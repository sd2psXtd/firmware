#include "splash.h"
#include "flashmap.h"
#include <debug.h>
#include <stdint.h>
#include <string.h>
#include "hardware/flash.h"
#include "hardware/regs/addressmap.h"
#include "pico/multicore.h"
#include "pico/platform.h"
#include "pico/time.h"
#include "sd.h"
#include "card_config.h"

uint8_t splash_img[1032] = {
  0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x60, 0x06, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x70, 0x0f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x78, 0x1e, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x3c, 0x3c, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x1e, 0x78, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00,
  0x1f, 0xfe, 0x7f, 0x80, 0x00, 0x00, 0x7f, 0xf0,
  0x1f, 0xfe, 0x07, 0xe0, 0x7f, 0xfe, 0x7f, 0xc0,
  0x7f, 0xfe, 0xff, 0xf0, 0x00, 0x00, 0xff, 0xfc,
  0x3f, 0xfe, 0x03, 0xc0, 0x7f, 0xff, 0x7f, 0xf0,
  0x7f, 0xfe, 0xff, 0xf8, 0x00, 0x00, 0xff, 0xfe,
  0x7f, 0xfe, 0x07, 0xe0, 0x7f, 0xfe, 0x7f, 0xfc,
  0xe0, 0x00, 0xc0, 0x3c, 0x00, 0x00, 0xe0, 0x06,
  0x60, 0x00, 0x0f, 0xf0, 0x01, 0x80, 0x60, 0x1c,
  0xc0, 0x00, 0xc0, 0x1c, 0x00, 0x00, 0xe0, 0x06,
  0xe0, 0x00, 0x1e, 0x78, 0x01, 0x80, 0x60, 0x0e,
  0xe0, 0x00, 0xc0, 0x0e, 0x00, 0x00, 0xe0, 0x06,
  0x60, 0x00, 0x3c, 0x3c, 0x01, 0x80, 0x60, 0x06,
  0xf0, 0x00, 0xc0, 0x06, 0x00, 0x00, 0xe0, 0x0e,
  0x70, 0x00, 0x78, 0x1e, 0x01, 0x80, 0x60, 0x07,
  0x7f, 0xf8, 0xc0, 0x06, 0xff, 0xfc, 0xff, 0xfc,
  0x7f, 0xfc, 0x70, 0x0f, 0x01, 0x80, 0x60, 0x07,
  0x3f, 0xfc, 0xc0, 0x06, 0xff, 0xfc, 0xff, 0xf8,
  0x1f, 0xfe, 0x60, 0x06, 0x01, 0x80, 0x60, 0x07,
  0x00, 0x0e, 0xc0, 0x06, 0x00, 0x0e, 0xe0, 0x00,
  0x00, 0x0e, 0x00, 0x00, 0x01, 0x80, 0x60, 0x07,
  0x00, 0x06, 0xc0, 0x0e, 0x00, 0x06, 0xe0, 0x00,
  0x00, 0x06, 0x00, 0x00, 0x01, 0x80, 0x60, 0x06,
  0x00, 0x06, 0xc0, 0x1c, 0x00, 0x06, 0xe0, 0x00,
  0x00, 0x06, 0x00, 0x00, 0x01, 0x80, 0x60, 0x0e,
  0x00, 0x0e, 0xc0, 0x3c, 0x00, 0x0e, 0xe0, 0x00,
  0x00, 0x0e, 0x00, 0x00, 0x01, 0x80, 0x60, 0x1c,
  0xff, 0xfc, 0xff, 0xf8, 0x1f, 0xfe, 0xe0, 0x00,
  0x7f, 0xfe, 0x00, 0x00, 0x01, 0x80, 0x7f, 0xf8,
  0xff, 0xf8, 0xff, 0xe0, 0x7f, 0xfc, 0xe0, 0x00,
  0xff, 0xfc, 0x00, 0x00, 0x01, 0x80, 0x7f, 0xf0,
  0x7f, 0xe0, 0x7f, 0x00, 0x70, 0x00, 0x00, 0x00,
  0x3f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80,
  0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x7f, 0xfc, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x1f, 0xfe, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

bool splash_game_image_available = false;

void splash_init(void) {
    /*if (((uint8_t*)FLASH_OFF_SPLASH + XIP_BASE)[sizeof(splash_img)] == 0x00) {
        // If the splash image is not set, copy the default image
        memcpy(splash_img, (void *)FLASH_OFF_SPLASH + XIP_BASE, sizeof(splash_img));
        printf("Default splash image loaded from flash.\n");
    }*/
}

void splash_update_current(const char* card_folder, const char* card_base) {
    splash_game_image_available = card_config_read_image(splash_img, card_folder, card_base);
}

bool splash_load_sd(void) {
    bool ret = false;
    if (sd_exists("splash.bin")) {
        int fd = sd_open("splash.bin", O_RDONLY);
        sd_read(fd, (void *)splash_img, sizeof(splash_img));
        sd_close(fd);
        sd_remove("splash.bin");
        DPRINTF("Splash image loaded from SD card.\n");
        ret = true;
    }
    return ret;
}
